# 학생 케이스 분석 기능 설정 가이드

## 개요

학생 DB 기능이 추가되어 다음과 같은 새로운 기능들을 사용할 수 있습니다:

### 새로운 기능들
- 학생별 분류별 케이스 소유 현황 추적
- 관리자 대시보드에서 학생별 분석 탭
- 분류별 케이스 분포 분석 (평균, 분포도)
- My Cases 페이지에서 개인 통계 및 진행률 표시
- 실시간 케이스 수 동기화

## 1. 데이터베이스 마이그레이션

### Supabase에서 실행해야 하는 SQL

`supabase-student-analytics-migration.sql` 파일의 내용을 Supabase SQL Editor에서 실행하세요.

이 스크립트는 다음을 수행합니다:
- `users` 테이블에 케이스 수 컬럼들 추가
- 자동 동기화 함수 및 트리거 생성
- 기존 데이터 초기 동기화

### 추가된 컬럼들
```sql
- case_count_가철: INTEGER DEFAULT 0
- case_count_고정: INTEGER DEFAULT 0
- case_count_임플: INTEGER DEFAULT 0
- case_count_임수: INTEGER DEFAULT 0
- total_cases: INTEGER DEFAULT 0
- last_case_sync: TIMESTAMP WITH TIME ZONE DEFAULT now()
```

## 2. 새로운 기능 사용법

### 관리자 기능

#### 대시보드
1. **전체 현황 탭**: 기존 대시보드 기능
2. **학생별 분석 탭**:
   - 모든 학생의 분류별 케이스 소유 현황 테이블
   - 각 학생별 가철/고정/임플/임수 케이스 수
3. **분류별 분석 탭**:
   - 각 분류별 상세 통계
   - 전체 케이스 수, 배정된 케이스 수, 학생당 평균
   - 0개/1개/2개/3개 이상 소유 학생 수

#### 동기화 기능
- "케이스 수 동기화" 버튼으로 모든 학생 데이터 강제 동기화
- 케이스 변경 시 자동 동기화 (트리거 기반)

### 학생 기능

#### My Cases 페이지 개선
1. **개인 통계 카드**:
   - 분류별 소유 케이스 수 표시
   - 각 분류별 완료율 진행바
   - 전체 완료율 표시

2. **분류별 케이스 목록**:
   - 각 분류마다 완료/진행/실패 케이스 수 표시
   - 분류별 진행률 표시
   - 상태별 Badge로 시각적 구분

3. **실시간 동기화**:
   - 케이스 상태 변경 시 자동 통계 업데이트
   - "동기화" 버튼으로 수동 동기화 가능

## 3. 자동화된 동기화

### 트리거 기반 실시간 동기화
케이스가 다음과 같이 변경될 때 자동으로 학생 통계가 업데이트됩니다:
- 새 케이스 추가
- 케이스 배정 변경 (교환, 양도)
- 케이스 상태 변경

### 수동 동기화
필요시 다음 방법으로 수동 동기화 가능:
- 관리자: 대시보드에서 "케이스 수 동기화" 버튼
- 학생: My Cases 페이지에서 "동기화" 버튼

## 4. 기술적 구현 세부사항

### 주요 파일들
- `src/utils/studentCaseAnalytics.ts`: 학생 분석 로직
- `src/hooks/useStudentCaseStats.ts`: 학생 통계 관련 훅
- `src/types/database.ts`: 타입 정의 업데이트
- `supabase-student-analytics-migration.sql`: DB 마이그레이션

### API 함수들
- `syncAllStudentCaseCounts()`: 모든 학생 동기화
- `syncStudentCaseCount(studentId)`: 특정 학생 동기화
- `getAllStudentStats()`: 모든 학생 통계 조회
- `getCategoryDistribution()`: 분류별 분포 분석

## 5. 성능 고려사항

### 자동 트리거
- 케이스 변경 시에만 관련 학생들의 통계만 업데이트
- 불필요한 전체 동기화 방지

### 캐싱
- React hooks를 통한 클라이언트 사이드 캐싱
- 실시간 업데이트와 성능의 균형

## 6. 향후 확장 가능성

### 추가 가능한 기능들
- 월별/분기별 통계
- 학생별 성과 트렌드 분석
- 케이스 완료 속도 분석
- 분류별 선호도 분석
- 엑셀/CSV 내보내기 기능

### 알림 기능
- 케이스 수 불균형 알림
- 목표 달성 알림
- 성과 리포트 자동 생성

## 7. 문제 해결

### 통계가 맞지 않는 경우
1. 관리자 대시보드에서 "케이스 수 동기화" 실행
2. 또는 SQL에서 `SELECT sync_student_case_counts();` 실행

### 실시간 업데이트가 안 되는 경우
1. 트리거가 제대로 생성되었는지 확인
2. 브라우저 새로고침 후 재시도
3. 네트워크 연결 상태 확인

## 설정 완료 후 확인사항

✅ Supabase에서 SQL 마이그레이션 실행 완료
✅ 관리자 대시보드에서 새 탭들이 표시됨
✅ 학생 My Cases에서 통계 카드가 표시됨
✅ 케이스 추가/수정 시 통계가 자동 업데이트됨
✅ 동기화 버튼들이 정상 작동함

모든 항목이 확인되면 학생 케이스 분석 기능이 정상적으로 설정된 것입니다.